// // import { OneSevenEightSeven as sample1, cartonsBristol250 as sample2 } from './json-samples';

// const cartonsBristol250 = {
//     ParsedResults: [
//         {
//             Overlay: {
//                 Lines: [
//                     {
//                         LineText: '100 001',
//                         Words: [
//                             {
//                                 WordText: '100',
//                                 Left: 30,
//                                 Top: 208,
//                                 Height: 10,
//                                 Width: 20,
//                             },
//                             {
//                                 WordText: '001',
//                                 Left: 51,
//                                 Top: 208,
//                                 Height: 10,
//                                 Width: 19,
//                             },
//                         ],
//                         MaxHeight: 10,
//                         MinTop: 208,
//                     },
//                     {
//                         LineText: '1 13',
//                         Words: [
//                             {
//                                 WordText: '1',
//                                 Left: 40,
//                                 Top: 226,
//                                 Height: 58,
//                                 Width: 36,
//                             },
//                             {
//                                 WordText: '13',
//                                 Left: 83,
//                                 Top: 226,
//                                 Height: 58,
//                                 Width: 65,
//                             },
//                         ],
//                         MaxHeight: 58,
//                         MinTop: 226,
//                     },
//                     {
//                         LineText: '35',
//                         Words: [
//                             {
//                                 WordText: '35',
//                                 Left: 212,
//                                 Top: 226,
//                                 Height: 58,
//                                 Width: 68,
//                             },
//                         ],
//                         MaxHeight: 58,
//                         MinTop: 226,
//                     },
//                     {
//                         LineText: '1',
//                         Words: [
//                             {
//                                 WordText: '1',
//                                 Left: 48,
//                                 Top: 288,
//                                 Height: 18,
//                                 Width: 10,
//                             },
//                         ],
//                         MaxHeight: 18,
//                         MinTop: 288,
//                     },
//                     {
//                         LineText: '13',
//                         Words: [
//                             {
//                                 WordText: '13',
//                                 Left: 106,
//                                 Top: 288,
//                                 Height: 20,
//                                 Width: 22,
//                             },
//                         ],
//                         MaxHeight: 20,
//                         MinTop: 288,
//                     },
//                     {
//                         LineText: '35',
//                         Words: [
//                             {
//                                 WordText: '35',
//                                 Left: 230,
//                                 Top: 286,
//                                 Height: 28,
//                                 Width: 28,
//                             },
//                         ],
//                         MaxHeight: 28,
//                         MinTop: 286,
//                     },
//                     {
//                         LineText: '102732',
//                         Words: [
//                             {
//                                 WordText: '102732',
//                                 Left: 84,
//                                 Top: 321,
//                                 Height: 60,
//                                 Width: 197,
//                             },
//                         ],
//                         MaxHeight: 60,
//                         MinTop: 321,
//                     },
//                     {
//                         LineText: '10',
//                         Words: [
//                             {
//                                 WordText: '10',
//                                 Left: 106,
//                                 Top: 382,
//                                 Height: 26,
//                                 Width: 24,
//                             },
//                         ],
//                         MaxHeight: 26,
//                         MinTop: 382,
//                     },
//                     {
//                         LineText: '27',
//                         Words: [
//                             {
//                                 WordText: '27',
//                                 Left: 156,
//                                 Top: 382,
//                                 Height: 26,
//                                 Width: 40,
//                             },
//                         ],
//                         MaxHeight: 26,
//                         MinTop: 382,
//                     },
//                     {
//                         LineText: '32',
//                         Words: [
//                             {
//                                 WordText: '32',
//                                 Left: 232,
//                                 Top: 382,
//                                 Height: 28,
//                                 Width: 28,
//                             },
//                         ],
//                         MaxHeight: 28,
//                         MinTop: 382,
//                     },
//                     {
//                         LineText: '9',
//                         Words: [
//                             {
//                                 WordText: '9',
//                                 Left: 36,
//                                 Top: 424,
//                                 Height: 54,
//                                 Width: 36,
//                             },
//                         ],
//                         MaxHeight: 54,
//                         MinTop: 424,
//                     },
//                     {
//                         LineText: '22',
//                         Words: [
//                             {
//                                 WordText: '22',
//                                 Left: 148,
//                                 Top: 420,
//                                 Height: 62,
//                                 Width: 70,
//                             },
//                         ],
//                         MaxHeight: 62,
//                         MinTop: 420,
//                     },
//                     {
//                         LineText: '22',
//                         Words: [
//                             {
//                                 WordText: '22',
//                                 Left: 172,
//                                 Top: 484,
//                                 Height: 20,
//                                 Width: 24,
//                             },
//                         ],
//                         MaxHeight: 20,
//                         MinTop: 484,
//                     },
//                     {
//                         LineText: '5164',
//                         Words: [
//                             {
//                                 WordText: '5164',
//                                 Left: 342,
//                                 Top: 226,
//                                 Height: 58,
//                                 Width: 132,
//                             },
//                         ],
//                         MaxHeight: 58,
//                         MinTop: 226,
//                     },
//                     {
//                         LineText: '51',
//                         Words: [
//                             {
//                                 WordText: '51',
//                                 Left: 366,
//                                 Top: 286,
//                                 Height: 24,
//                                 Width: 24,
//                             },
//                         ],
//                         MaxHeight: 24,
//                         MinTop: 286,
//                     },
//                     {
//                         LineText: '64',
//                         Words: [
//                             {
//                                 WordText: '64',
//                                 Left: 428,
//                                 Top: 286,
//                                 Height: 24,
//                                 Width: 24,
//                             },
//                         ],
//                         MaxHeight: 24,
//                         MinTop: 286,
//                     },
//                     {
//                         LineText: '5660',
//                         Words: [
//                             {
//                                 WordText: '5660',
//                                 Left: 340,
//                                 Top: 322,
//                                 Height: 58,
//                                 Width: 134,
//                             },
//                         ],
//                         MaxHeight: 58,
//                         MinTop: 322,
//                     },
//                     {
//                         LineText: '56',
//                         Words: [
//                             {
//                                 WordText: '56',
//                                 Left: 362,
//                                 Top: 382,
//                                 Height: 26,
//                                 Width: 30,
//                             },
//                         ],
//                         MaxHeight: 26,
//                         MinTop: 382,
//                     },
//                     {
//                         LineText: '49',
//                         Words: [
//                             {
//                                 WordText: '49',
//                                 Left: 276,
//                                 Top: 420,
//                                 Height: 58,
//                                 Width: 68,
//                             },
//                         ],
//                         MaxHeight: 58,
//                         MinTop: 420,
//                     },
//                     {
//                         LineText: '49',
//                         Words: [
//                             {
//                                 WordText: '49',
//                                 Left: 300,
//                                 Top: 488,
//                                 Height: 14,
//                                 Width: 18,
//                             },
//                         ],
//                         MaxHeight: 14,
//                         MinTop: 488,
//                     },
//                     {
//                         LineText: 'www.cartaloto.net - 05.63.38.34.64',
//                         Words: [
//                             {
//                                 WordText: 'www.cartaloto.net',
//                                 Left: 238,
//                                 Top: 504,
//                                 Height: 10,
//                                 Width: 76,
//                             },
//                             {
//                                 WordText: '-',
//                                 Left: 316,
//                                 Top: 504,
//                                 Height: 10,
//                                 Width: 2,
//                             },
//                             {
//                                 WordText: '05.63.38.34.64',
//                                 Left: 319,
//                                 Top: 504,
//                                 Height: 10,
//                                 Width: 63,
//                             },
//                         ],
//                         MaxHeight: 10,
//                         MinTop: 504,
//                     },
//                     {
//                         LineText: '7985',
//                         Words: [
//                             {
//                                 WordText: '7985',
//                                 Left: 470,
//                                 Top: 420,
//                                 Height: 58,
//                                 Width: 130,
//                             },
//                         ],
//                         MaxHeight: 58,
//                         MinTop: 420,
//                     },
//                     {
//                         LineText: '79',
//                         Words: [
//                             {
//                                 WordText: '79',
//                                 Left: 492,
//                                 Top: 484,
//                                 Height: 22,
//                                 Width: 22,
//                             },
//                         ],
//                         MaxHeight: 22,
//                         MinTop: 484,
//                     },
//                     {
//                         LineText: '85',
//                         Words: [
//                             {
//                                 WordText: '85',
//                                 Left: 554,
//                                 Top: 488,
//                                 Height: 16,
//                                 Width: 20,
//                             },
//                         ],
//                         MaxHeight: 16,
//                         MinTop: 488,
//                     },
//                 ],
//                 HasOverlay: true,
//             },
//             FileParseExitCode: 1,
//             TextOrientation: '0',
//             ParsedText:
//                 '100 001\n1 13\n35\n1\n13\n35\n102732\n10\n27\n32\n9\n22\n22\n5164\n51\n64\n5660\n56\n49\n49\nwww.cartaloto.net - 05.63.38.34.64\n7985\n79\n85',
//             ErrorMessage: '',
//             ErrorDetails: '',
//         },
//     ],
//     OCRExitCode: 1,
//     IsErroredOnProcessing: false,
//     ProcessingTimeInMilliseconds: 0.656,
//     SearchablePDFURL: 'Searchable PDF not generated as it was not requested.',
// };

// type OCRWord = {
//     WordText: string;
//     Left: number;
//     Top: number;
//     Height: number;
//     Width: number;
// };

// type OCRLine = {
//     LineText: string;
//     Words: OCRWord[];
//     MaxHeight: number;
//     MinTop: number;
// };

// type LotoGrid = [LotoLine, LotoLine, LotoLine];

// type LotoLine = [LotoCell, LotoCell, LotoCell, LotoCell, LotoCell, LotoCell, LotoCell, LotoCell, LotoCell];

// type LotoCell = number | null;

// type LineNumber = 0 | 1 | 2;

// type ProcessingGrid = {
//     currentLine: LineNumber;
//     prevLine?: LineNumber;
//     max: number;
//     prev: number;
//     grid: LotoGrid;
// };

// type LotoCol = { values: [LotoCell, LotoCell, LotoCell]; start: number; end: number };

// const createEmptyGrid = (): LotoGrid => {
//     const emptyLine = [null, null, null, null, null, null, null, null, null] as LotoLine;
//     return [[...emptyLine], [...emptyLine], [...emptyLine]];
// };

// const detectCol = (value: string): number => {
//     const parsedValue = parseInt(value);
//     // Si le nombre est < 10 ou > 89, on prend le premier chiffre de sa dizaine pour le placer
//     // Si < 10, c'est la première ligne
//     // Sinon c'est la dernière
//     if (parsedValue > 10 && parsedValue < 89) {
//         return parseInt(value[0]);
//     } else if (parsedValue < 10) {
//         return 0;
//     } else {
//         return 8;
//     }
// };
// let smallChars: CharSizePool;
// let bigChars: CharSizePool;
// let row1FromTop: number;
// let row2FromTop: number;
// let row3FromTop: number;

// const detectLine = (
//     value: OCRWord,
//     grid: LotoGrid,
//     currentLineNumber: LineNumber,
//     prev: number,
//     max: number
// ): LineNumber => {
//     const col = detectCol(value.WordText);
//     const parsedValue = parseInt(value.WordText);

//     // Si la grille est vide, on peut partir du postulat qu'on est sur la première ligne
//     // On enregistre la hauteur de caractère

//     // // Si la valeur précédente était plus élevée, il y a beaucoup de chances qu'on passe sur une nouvelle ligne
//     // if (prev > parsedValue) {
//     //     if (currentLineNumber >= 2) {
//     //         throw new Error('cannot go to further line');
//     //     } else {
//     //         return (currentLineNumber + 1) as LineNumber;
//     //     }
//     // }

//     // // Si on a jamais été sur une aussi grosse valeur, il y a beaucoup de chances qu'on soit remonté sur la première ligne
//     // if (parsedValue > max) {
//     //     // Si la colonne n'a pas déja de nombre et que toutes les suivantes sont vides, on peut partir du postulat qu'on est sur la première ligne
//     //     let canGoToFirstLine = true;
//     //     let currentCol = col;
//     //     do {
//     //         if (!isColEmpty(currentCol, grid)) {
//     //             canGoToFirstLine = false;
//     //         }
//     //         currentCol++;
//     //     } while (canGoToFirstLine && currentCol < 9);
//     //     if (canGoToFirstLine) {
//     //         return 0;
//     //     }
//     //     // Si on ne peut pas aller à la première ligne on reste sur l'actuelle
//     // }

//     if (value.Top < row2FromTop) return 0;
//     if (value.Top >= row2FromTop && value.Top < row3FromTop) return 1;
//     else return 2;

//     // Si la colonne de la ligne actuelle est déja remplie, on tente d'aller à la suivante
//     if (grid[currentLineNumber][col]) {
//         if (currentLineNumber === 0 && !grid[1][col] && !grid[2][col]) {
//             return 1;
//         }

//         if (currentLineNumber === 1 && !grid[2][col]) {
//             return 2;
//         }

//         throw new Error('cannot go to further line');
//     }

//     return currentLineNumber;
// };

// const valueFitsInCurrentLine = (value: string, line: LotoLine): boolean => {
//     return Boolean(line[detectCol(value)]);
// };

// const isPresentInGrid = (value: string, grid: LotoGrid): boolean => {
//     return grid.some((line: LotoLine) => line.some((cell: LotoCell) => cell === parseInt(value)));
// };

// const processOCRWord = (word: OCRWord) => {};

// type CharSizePool = { sizes: number[]; max: number; min: number; average: number };

// /**
//  * Détermine les tranches de tailles qui correspondent aux petits et gros caractères
//  * Avoir cette information va permettre de positionner avec certitude les caractères qui sont gros
//  * Si un caractère n'est pas gros, on peut voir s'il correspond au standard des petits caractères pour le placer
//  * @param ocrOutput
//  * @returns
//  */
// const detectCharSizes = (ocrOutput: OCRLine[]): { bigCharSize: CharSizePool; smallCharSize?: CharSizePool } => {
//     const detectedCharSizes = ocrOutput.reduce((acc: number[], line: OCRLine) => {
//         return [...acc, line.MaxHeight];
//     }, []);

//     /**
//      * Find the index of the pool that fits the size with a +-20% margin
//      * @param size
//      * @param pools
//      * @returns index of the pool that fits the size
//      * */
//     const findFittingSizePoolIndex = (size: number, pools: CharSizePool[]): number => {
//         return pools.findIndex((pool) => size >= pool.min * 0.8 && size <= pool.max * 1.2);
//     };

//     const updatePool = (pool: CharSizePool, size: number): CharSizePool => {
//         return {
//             sizes: [...pool.sizes, size],
//             max: Math.max(pool.max, size),
//             min: Math.min(pool.min, size),
//             average: pool.sizes.reduce((acc, value) => acc + value, 0) / pool.sizes.length,
//         };
//     };

//     const charSizePools: CharSizePool[] = [];

//     // console.log('ocrOutput: ', ocrOutput);
//     // console.log('detectedCharSizes: ', detectedCharSizes);

//     detectedCharSizes.forEach((size) => {
//         // Si c'est le premier caractère, on crée un pool
//         if (!charSizePools.length) {
//             charSizePools.push({ sizes: [size], max: size, min: size, average: size });
//             return;
//         }

//         const fittingSizePoolIndex = findFittingSizePoolIndex(size, charSizePools);

//         // Si on n'a pas trouvé de pool qui correspond, on en crée un nouveau
//         if (fittingSizePoolIndex === -1) {
//             charSizePools.push({ sizes: [size], max: size, min: size, average: size });
//             return;
//         }

//         const pool = updatePool(charSizePools[fittingSizePoolIndex], size);
//         charSizePools[fittingSizePoolIndex] = pool;
//     });

//     // On prend le pool avec la plus grande moyenne
//     const bigCharPoolIndex = charSizePools.findIndex(
//         (pool) => pool.average === Math.max(...charSizePools.map((pool) => pool.average))
//     );
//     if (bigCharPoolIndex === -1) {
//         throw new Error('No char pool found');
//     }

//     // Pour les petits caractères, on prend le pool qui a le plus de valeurs
//     const smallCharPool = charSizePools.find(
//         (pool, index) =>
//             index !== bigCharPoolIndex &&
//             pool.sizes.length === Math.max(...charSizePools.map((pool) => pool.sizes.length))
//     );

//     return {
//         bigCharSize: charSizePools[bigCharPoolIndex],
//         smallCharSize: smallCharPool,
//     };
// };

// const isABigChar = (charSize: number) => charSize >= bigChars.min && charSize <= bigChars.max;
// const isASmallChar = (charSize: number) => charSize >= smallChars.min && charSize <= smallChars.max;

// /**
//  *
//  * Si on tombe sur une petite taille de caractère, on cherche le même en gros caractère
//  * Si on le trouve, on le dismiss
//  * Sinon on le conserve
//  * @param ocrOutput
//  * @returns
//  */
// const sanitizeDuplicates = (ocrOutput: OCRLine[]): OCRLine[] => {
//     return ocrOutput.reduce((acc: OCRLine[], line: OCRLine) => {
//         // Si on tombe sur une grosse taille de caractère, on peut process tranquillement le nombre
//         if (isABigChar(line.MaxHeight)) {
//             return [...acc, line];
//         }

//         // Si on tombe sur une petite taille de caractère, on cherche un gros caractère avec
//         const availableBigNumbers = line.Words.filter((word) =>
//             ocrOutput.find((l) => l.Words.some((w) => w.WordText === word.WordText) && isABigChar(l.MaxHeight))
//         );
//         // Si toute la ligne est disponible en gros caractère, on prendra la ligne disponible en gros, et on skip celle ci
//         // Dans le cas où on arrive pas à retrouver la ligne ET que la taille de caractère ne correspond pas aux standards, on la skip également
//         if (availableBigNumbers.length === line.Words.length || (smallChars && !isASmallChar(line.MaxHeight))) {
//             return acc;
//         }

//         // Si la ligne n'est pas en gros caractères, on retire les nombres qui sont tout de même en gros caractères
//         return [
//             ...acc,
//             {
//                 ...line,
//                 Words: [
//                     ...line.Words.filter((word) => !availableBigNumbers.map((n) => n.WordText).includes(word.WordText)),
//                 ],
//             },
//         ];
//     }, []);
// };

// const setNumberInLine = (value: string, line: LotoLine, max: number): { max: number; prev: number; line: LotoLine } => {
//     const parsedValue = parseInt(value);
//     // Si le nombre est < 10 ou > 89, on prend le premier chiffre de sa dizaine pour le placer
//     // Si < 10, c'est la première ligne
//     // Sinon c'est la dernière
//     if (parsedValue >= 10 && parsedValue < 89) {
//         const col = parseInt(value[0]);
//         line[col] = parsedValue;
//     } else if (parsedValue < 10) {
//         line[0] = parsedValue;
//     } else {
//         line[8] = parsedValue;
//     }

//     max = max < parsedValue ? parsedValue : max;

//     return {
//         line,
//         max,
//         prev: parsedValue,
//     };
// };

// const detectRows = (ocrOutput: OCRLine[]) => {
//     const avgBigCharSize = bigChars.average;
//     // First row is starts at the top of the first big char
//     row1FromTop = ocrOutput
//         .filter((line) => isABigChar(line.Words[0].Height))
//         .toSorted((a, b) => a.MinTop - b.MinTop)[0].MinTop;

//     row2FromTop = ocrOutput
//         .filter((line) => isABigChar(line.Words[0].Height))
//         .filter((line) => line.MinTop > row1FromTop + avgBigCharSize)
//         .toSorted((a, b) => a.MinTop - b.MinTop)[0].MinTop;

//     // Third row is the last big char
//     row3FromTop = ocrOutput
//         .filter((line) => isABigChar(line.Words[0].Height))
//         .filter((line) => line.MinTop > row2FromTop + avgBigCharSize)
//         .toSorted((a, b) => a.MinTop - b.MinTop)[0].MinTop;
// };

// const cleanNonGridNumbers = (ocrOutput: OCRLine[]) => {
//     let sanitizedGrid: OCRLine[] = [];

//     // If the grid is only composed of big characters (no small characters),
//     // We can safely remove all non big characters
//     if (!smallChars) {
//         sanitizedGrid = ocrOutput.filter((line) => isABigChar(line.MaxHeight));
//     }

//     return sanitizedGrid;
// };

// const processGrid = (ocrOutput: OCRLine[]) => {
//     // Avant de commencer à process le contenu, on exclue les lignes qui contiennent autre chose que des chiffres ou des espaces
//     const linesWithNumbers = ocrOutput.filter((line) => line.LineText.match(/^[0-9\s]+$/));

//     // On fait un comparatif entre les lignes pour identifier les hauteurs moyennes des petits et gros caractères
//     const { bigCharSize, smallCharSize } = detectCharSizes(linesWithNumbers);
//     bigChars = bigCharSize;
//     if (smallCharSize) smallChars = smallCharSize;

//     const sanitizedLines = sanitizeDuplicates(linesWithNumbers);
//     const gridNumbers = cleanNonGridNumbers(sanitizedLines);
//     console.log('sanitizedLines: ', sanitizedLines);

//     // Remove lines that should not be considered as grid numbers

//     // Detect rows
//     detectRows(gridNumbers);

//     const grid = gridNumbers.reduce(
//         (acc: ProcessingGrid, value: OCRLine) => {
//             const targetLine = detectLine(value.Words[0], acc.grid, acc.currentLine, acc.prev, acc.max);

//             const numbersInOCRLine = value.Words.map((word) => word.WordText);

//             let updatedLine: { max: number; prev: number; line: LotoLine } = {
//                 max: acc.max,
//                 prev: acc.prev,
//                 line: acc.grid[targetLine],
//             };

//             numbersInOCRLine.forEach((number) => {
//                 //  Si il y a plus de 2 chiffres alors on a affaire à une suite qu'il va falloir séparer
//                 if (number.length > 2 && number.length % 2 === 0) {
//                     for (let i = 0; i < number.length; i += 2) {
//                         const integer = number.slice(i, i + 2);
//                         updatedLine = setNumberInLine(integer, acc.grid[targetLine], acc.max);
//                     }
//                 } else if (number.length > 2 && number.length % 2 !== 0) {
//                     const firstInteger = number.slice(0, 1);
//                     updatedLine = setNumberInLine(firstInteger, acc.grid[targetLine], acc.max);
//                     for (let i = 1; i < number.length; i += 2) {
//                         const integer = number.slice(i, i + 2);
//                         updatedLine = setNumberInLine(integer, acc.grid[targetLine], acc.max);
//                     }
//                 } else {
//                     //  Si le nombre existe déja, on le skip
//                     if (!isPresentInGrid(number, acc.grid)) {
//                         updatedLine = setNumberInLine(number, acc.grid[targetLine], acc.max);
//                     }
//                 }
//             });

//             // wordsInLine.forEach((word) => {
//             // meta = setNumberInLine(word., acc.grid[lineToWrite], acc.max);
//             // });

//             // Utiliser le minTop ainsi que tester l'existance dans la colonne pour déterminer la ligne

//             // // Si le nombre existe déja, on le skip
//             // if (isPresentInGrid(value., acc.grid)) {
//             //     return acc;
//             // }

//             // let meta, lineToWrite: LineNumber;

//             // // Si la valeur est plus longue que 2 chiffres, alors on a affaire à une suite
//             // // De là on peut facilement placer les chiffres à la suite dans la ligne
//             // if (isValueAFlushOfNumbers(value)) {
//             //     console.log('flush values: ', value);
//             //     const numbers = getNumbersInFlush(value);
//             //     console.log('numbers in flush: ', numbers);
//             //     console.log('currentLine: ', acc.currentLine);
//             //     lineToWrite = detectLine(numbers[0], acc.grid, acc.currentLine, acc.prev, acc.max);
//             //     numbers.forEach((integer) => {
//             //         meta = setNumberInLine(integer, acc.grid[lineToWrite], acc.max);
//             //     });
//             // } else {
//             //     lineToWrite = detectLine(value, acc.grid, acc.currentLine, acc.prev, acc.max);
//             //     meta = setNumberInLine(value, acc.grid[lineToWrite], acc.max);
//             // }

//             const newGrid = [...acc.grid];
//             newGrid[targetLine] = updatedLine.line;

//             return {
//                 currentLine: targetLine,
//                 prev: parseInt(updatedLine.prev.toString()),
//                 max: updatedLine?.max ?? acc.max,
//                 grid: newGrid,
//             } as ProcessingGrid;
//         },
//         {
//             currentLine: 0,
//             prev: 0,
//             max: 0,
//             grid: createEmptyGrid(),
//         } as ProcessingGrid
//     );

//     console.log('final grid: ', grid);
// };

// processGrid(cartonsBristol250.ParsedResults[0].Overlay.Lines);
